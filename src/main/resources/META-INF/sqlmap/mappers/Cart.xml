<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
  <mapper namespace="com.ocsy.checkin.dao.CartDao">
  	<resultMap type="Cart" id="CartResult">
  		<result property="cartnum" column="cartnum"/>
        <result property="pnum" column="pnum"/>
        <result property="mid" column="mid"/>
        <result property="cost" column="cost"/>
        <result property="qty" column="qty"/>
 
        <result property="pimage1" column="pimage1"/>
        <result property="pname" column="pname"/>
        <result property="pprice" column="pprice"/>


        <result property="or_num" column="or_num"/>
        <result property="ordate" column="ordate"/>
        <result property="ord_num" column="ord_num"/>
  		
  	</resultMap>
  	
  	
  	<!-- insertCart / 장바구니 상품 입력 -->
  	<insert id="insertCart" parameterType="Cart">
  	<![CDATA[
         INSERT INTO CART (CARTNUM, PNUM, MID, COST, QTY)
    VALUES(CART_SEQ.NEXTVAL, #{pnum}, #{mid}, #{qty}*(SELECT PPRICE FROM TAXFREE WHERE PNUM = #{pnum}), #{qty})
      ]]>
  	</insert>
  	
  	<!-- listCart / mid로 장바구니 담긴 것 출력 / O -->
  	<select id="listCart" parameterType="String" resultMap="CartResult">
  	<![CDATA[
		SELECT * FROM CART C, TAXFREE T WHERE C.PNUM = T.PNUM AND MID = #{mid} ORDER BY CARTNUM DESC
      ]]>
    </select>
  	
  	<!-- deleteCart / 카트 번호를 받아서 항목 1개 삭제 / O -->
  	<delete id="deleteCart" parameterType="Cart">
  		DELETE FROM CART WHERE CARTNUM = #{cartnum}
  	</delete>
  	
  	<!-- deleteCartAll / 전체 삭제 진행 시 mid로 삭제 진행 / O -->
  	<delete id="deleteCartAll" parameterType="Cart">
  		DELETE FROM CART WHERE MID = #{mid}
  	</delete>
  	
  	<!-- totCnt / 카트에 담긴 개수 확인 / O -->
  	<select id="totCntCart" parameterType="Cart" resultType="int">
  		SELECT COUNT(*) FROM CART WHERE MID= #{mid} AND PNUM = #{pnum}
  	</select>
  	
  	<!-- updateCart / 장바구니 물건 개수 수정 /  O -->
  	<update id = "updateCart" parameterType="Cart">
  	<![CDATA[
  	UPDATE CART SET QTY = #{qty} + (SELECT QTY FROM CART WHERE PNUM = #{pnum} AND MID = #{mid}),
                COST = (2 + (SELECT QTY FROM CART WHERE PNUM = #{pnum} AND MID = #{mid})) * (SELECT PPRICE FROM TAXFREE WHERE PNUM = #{pnum})
            WHERE PNUM = #{pnum} AND MID = #{mid}
    ]]>
  	</update>
  	
  	<!-- updateInCart / 장바구니 안에서 수정 / 진행 중 -->
  	<update id="updateInCart" parameterType="Cart">
        UPDATE CART SET QTY = #{qty},
                COST = #{qty} * (SELECT PPRICE FROM TAXFREE WHERE PNUM = (select pnum from cart where cartnum=#{cartnum}))
            WHERE CARTNUM = #{cartnum}
  	</update>
  	
  	
  	
  	
  	<!-- 카트에 담긴 상품 order에 넣기  -->
  	<insert id="cartOrder" parameterType="String">
  	INSERT INTO ORDERS VALUES (ORDER_SEQ.NEXTVAL, #{mid}, SYSDATE)
  	</insert>
  
  	<!--  X order에 있는 order 리스트 출력  -->
  	<select id="orderlist" parameterType="String" resultType="String">
  	 SELECT OR_NUM FROM ORDERS O , CART C WHERE O.MID=C.MID AND O.MID=#{mid}
  	</select>
 
    <!-- orderdetail 에 order 주문번호와 cart 내용 넘기기 -->
  	<insert id="cartOrderDetail" parameterType="String">
  	<![CDATA[
	INSERT INTO ORDER_DETAIL 
    SELECT ORDERDETAIL_SEQ.NEXTVAL, (SELECT OR_NUM FROM ORDERS WHERE MID=#{mid} AND OR_NUM=(select max(or_num) from oders)), PNUM, COST, QTY FROM CART WHERE MID=#{mid}
  	]]>
  	</insert>
  
   <!-- 주문 완료 후 장바구니에 있는 상품 지우기  -->
     <delete id="cartDelete" parameterType="Cart">
	DELETE FROM CART WHERE MID=#{mid} AND PNUM = (SELECT PNUM FROM ORDERS WHERE OR_NUM = #{or_num})
  	</delete>
  	
  	
<<<<<<< HEAD
=======
  
  	
  	
  	
>>>>>>> de1dd12d2627aa43b4ba9028f282138a70f1485c
  	
  	
  </mapper>